<!DOCTYPE html>
<html lang="en">
<head>
  <!-- iOS and PWA Setup -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Select Points</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="styles.css" />

  <!-- Mapbox + Leaflet -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>

  <!-- Header -->
  <header>Select Start and End</header>

  <!-- Main Content -->
  <main>
    <div id="map" style="height: 60vh;"></div>

    <div class="instructions">
      <p>Tap on the map to select your Start and End points.</p>
      <button id="setStart">Set Start</button>
      <button id="setEnd">Set End</button>
      <button id="buildRoute">Build Route</button>
    </div>

    <pre id="debugLog">Ready...</pre>
  </main>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <button onclick="history.back()">ğŸ”™ Back</button>
    <button onclick="location.href='index.html'">ğŸ  Home</button>
    <button onclick="location.href='settings.html'">âš™ï¸ Settings</button>
  </nav>

  <!-- JS Logic -->
  <script>
    mapboxgl.accessToken = 'pk.eyJ1Ijoic2VhbmxlZTkyIiwiYSI6ImNtZTAyeG0wbzAwamgybHE2cmwzenJtM2cifQ.DE8FeoDvc3EzuyR5uPopzA';

    const map = L.map('map').setView([42.99, -105.55], 6);
    L.tileLayer(`https://api.mapbox.com/styles/v1/mapbox/streets-v11/tiles/{z}/{x}/{y}?access_token=${mapboxgl.accessToken}`, {
      attribution: 'Â© Mapbox Â© OpenStreetMap',
      tileSize: 512,
      zoomOffset: -1
    }).addTo(map);

    let selectingStart = false;
    let selectingEnd = false;
    let startMarker = null;
    let endMarker = null;
    const debugLog = document.getElementById('debugLog');

    let parsedSteps = [];

    // Get OCR data from index
    const rawText = localStorage.getItem('ocrText') || '';
    const permitLines = rawText.split('\n').map(l => l.trim()).filter(l =>
      l.match(/\b(US|I|SR|HWY|Hwy|FM|WY|CR|BUS)-?\s?\d+/i) ||
      l.toLowerCase().includes("take") ||
      l.toLowerCase().includes("continue") ||
      l.toLowerCase().includes("exit") ||
      l.toLowerCase().includes("merge") ||
      l.toLowerCase().includes("turn") ||
      l.toLowerCase().includes("onto")
    );
    parsedSteps = permitLines;

    debugLog.textContent = `Loaded ${parsedSteps.length} segments from permit.`;

    document.getElementById('setStart').onclick = () => {
      selectingStart = true;
      selectingEnd = false;
    };

    document.getElementById('setEnd').onclick = () => {
      selectingEnd = true;
      selectingStart = false;
    };

    map.on('click', (e) => {
      const { lat, lng } = e.latlng;
      if (selectingStart) {
        if (startMarker) map.removeLayer(startMarker);
        startMarker = L.marker([lat, lng]).addTo(map).bindPopup("Start").openPopup();
        selectingStart = false;
        localStorage.setItem('manualStart', JSON.stringify([lat, lng]));
      } else if (selectingEnd) {
        if (endMarker) map.removeLayer(endMarker);
        endMarker = L.marker([lat, lng]).addTo(map).bindPopup("End").openPopup();
        selectingEnd = false;
        localStorage.setItem('manualEnd', JSON.stringify([lat, lng]));
      }
    });

    document.getElementById('buildRoute').onclick = async () => {
      if (!startMarker || !endMarker) {
        alert("Set both start and end points.");
        return;
      }

      const start = startMarker.getLatLng();
      const end = endMarker.getLatLng();

      debugLog.textContent = "Building route with AI waypointsâ€¦";

      // This is where you'd normally geocode and filter waypoints.
      // For demo, we skip straight to building route:
      const coordinates = [
        [start.lng, start.lat],
        [end.lng, end.lat]
      ];

      const url = `https://api.mapbox.com/directions/v5/mapbox/driving/${coordinates.map(c => c.join(',')).join(';')}?geometries=geojson&access_token=${mapboxgl.accessToken}`;

      try {
        const res = await fetch(url);
        const data = await res.json();

        if (data.routes && data.routes.length) {
          const route = data.routes[0].geometry;
          L.geoJSON(route).addTo(map);
          debugLog.textContent = "Route successfully built!";
        } else {
          debugLog.textContent = "Mapbox couldnâ€™t build route.";
        }
      } catch (err) {
        debugLog.textContent = "Error building route: " + err;
      }
    };
  </script>
</body>
</html>