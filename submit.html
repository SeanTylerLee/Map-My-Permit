<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Submit Permit • Map My Permit</title>

  <link rel="stylesheet" href="styles.css" />

  <!-- Mapbox -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <!-- Tesseract OCR -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>
<body>
  <!-- Top bar -->
  <header class="app-header">
    <button class="icon-btn" onclick="history.back()" aria-label="Back">
      <img src="images/back.png" alt="Back" />
    </button>
    <h1 class="app-title">Submit Permit</h1>
    <a class="icon-btn" href="index.html" aria-label="Home">
      <img src="images/home.png" alt="Home" />
    </a>
  </header>

  <main class="content">
    <!-- Upload -->
    <section class="card">
      <h2 class="section-title">Upload or Take Photo</h2>
      <input id="fileInput" type="file" accept="image/*" />
      <div class="preview-wrap"><img id="preview" alt="Preview" /></div>
      <p id="status" class="muted small">Select a clear photo of the permit.</p>
      <div class="row">
        <button id="reRunBtn" class="ghost-btn" disabled>Re-run OCR</button>
        <button id="clearBtn" class="ghost-btn">Clear</button>
      </div>
    </section>

    <!-- OCR text -->
    <section class="card">
      <h2 class="section-title">Detected Text</h2>
      <textarea id="ocrText" class="mono" rows="8" readonly placeholder="OCR results will appear here…"></textarea>
    </section>

    <!-- Parsed -->
    <section class="card">
      <h2 class="section-title">Parsed Route</h2>
      <div class="row small">
        <label class="chip">Start: <span id="startLabel" class="bold">--</span></label>
        <label class="chip">End: <span id="endLabel" class="bold">--</span></label>
      </div>
      <textarea id="parsedBox" class="mono" rows="8" readonly></textarea>
      <div class="row">
        <button id="editParsedBtn" class="ghost-btn">Edit JSON</button>
        <button id="buildBtn" class="primary-btn" disabled>Build Route</button>
        <button id="saveBtn" class="ghost-btn" disabled>Save</button>
      </div>
    </section>

    <!-- Map + steps -->
    <section class="card">
      <h2 class="section-title">Map & Steps</h2>
      <div id="map" class="map"></div>
      <ol id="steps" class="small" style="margin-top:10px;padding-left:18px;"></ol>
      <div class="chip-row">
        <button id="pickStart" class="chip">Pick Start</button>
        <button id="pickEnd" class="chip">Pick End</button>
        <button id="addWp" class="chip">Add Waypoint</button>
        <button id="clearWp" class="chip">Clear</button>
      </div>
    </section>
  </main>
  
  <!-- spacer  -->
  <div style="height: 120px;"></div>
  

  <!-- Bottom nav -->
  <nav class="tabbar">
    <a class="tab" href="index.html"><img src="images/home.png" alt=""><span>Home</span></a>
    <a class="tab" href="routes.html"><img src="images/settings.png" alt=""><span>Routes</span></a>
  </nav>

<script>
/* ========== Config ========== */
mapboxgl.accessToken = 'pk.eyJ1Ijoic2VhbmxlZTkyIiwiYSI6ImNtZTAyeG0wbzAwamgybHE2cmwzenJtM2cifQ.DE8FeoDvc3EzuyR5uPopzA';

/* ========== DOM ========== */
const fileInput = document.getElementById('fileInput');
const preview   = document.getElementById('preview');
const statusEl  = document.getElementById('status');
const reRunBtn  = document.getElementById('reRunBtn');
const clearBtn  = document.getElementById('clearBtn');

const ocrText   = document.getElementById('ocrText');
const parsedBox = document.getElementById('parsedBox');
const startLabel= document.getElementById('startLabel');
const endLabel  = document.getElementById('endLabel');

const buildBtn  = document.getElementById('buildBtn');
const saveBtn   = document.getElementById('saveBtn');
const editParsedBtn = document.getElementById('editParsedBtn');

const stepsEl   = document.getElementById('steps');

/* ========== Map init ========== */
let start=null, end=null, waypoints=[];
let map = new mapboxgl.Map({
  container:'map', style:'mapbox://styles/mapbox/streets-v12',
  center:[-104.99,41.14], zoom:6
});
map.addControl(new mapboxgl.NavigationControl(), 'top-right');

let startMarker, endMarker, wpMarkers=[];
let clickMode=null;
map.on('click', (e)=>{
  if(!clickMode) return;
  const p=e.lngLat;
  if(clickMode==='start'){ start=p; addMarker('start',p); }
  if(clickMode==='end'){ end=p; addMarker('end',p); }
  if(clickMode==='wp'){ waypoints.push(p); addMarker('wp',p); }
  clickMode=null;
  buildBtn.disabled = !(start && end);
});
function addMarker(type, lngLat){
  if(type==='start'){
    if(!startMarker) startMarker=new mapboxgl.Marker({color:'#2ecc71'});
    startMarker.setLngLat(lngLat).addTo(map);
  } else if(type==='end'){
    if(!endMarker) endMarker=new mapboxgl.Marker({color:'#e74c3c'});
    endMarker.setLngLat(lngLat).addTo(map);
  } else {
    const m=new mapboxgl.Marker(); m.setLngLat(lngLat).addTo(map); wpMarkers.push(m);
  }
}
function clearRoute(){
  if(map.getSource('route')){ map.removeLayer('route'); map.removeSource('route'); }
  stepsEl.innerHTML='';
}

/* ========== Upload → OCR → Parse → Geocode → Route ========== */
fileInput.addEventListener('change', async ()=>{
  const f=fileInput.files?.[0]; if(!f) return;
  preview.src = URL.createObjectURL(f);
  reRunBtn.disabled = false;
  await runPipeline(f);
});
reRunBtn.addEventListener('click', async ()=>{
  const f=fileInput.files?.[0]; if(!f) return;
  await runPipeline(f);
});
clearBtn.addEventListener('click', ()=>{
  fileInput.value=''; preview.removeAttribute('src');
  ocrText.value=''; parsedBox.value='';
  startLabel.textContent=endLabel.textContent='--';
  start=end=null; waypoints=[]; wpMarkers.forEach(m=>m.remove()); wpMarkers=[];
  if(startMarker) startMarker.remove(); if(endMarker) endMarker.remove();
  clearRoute(); buildBtn.disabled=true; saveBtn.disabled=true;
  statusEl.textContent='Select a clear photo of the permit.';
});

async function runPipeline(file){
  try{
    statusEl.textContent='Running OCR…';
    reRunBtn.disabled = true; buildBtn.disabled = true; saveBtn.disabled = true;

    // OCR
    const { data } = await Tesseract.recognize(file,'eng',{
      logger:m=>{ if(m.status && m.progress!=null){ statusEl.textContent = `${m.status} ${Math.round(m.progress*100)}%`; } }
    });
    const text=(data?.text||'').trim();
    ocrText.value=text;

    // Parse
    statusEl.textContent='Parsing permit…';
    const parsed = parseWy(text) || parseSimple(text);
    parsedBox.value = JSON.stringify(parsed,null,2);

    // Resolve start/end labels
    const s = (parsed.origin||parsed.start||parsed.startText||'').trim();
    const d = (parsed.destination||parsed.end||parsed.endText||'').trim();
    startLabel.textContent = s || '--';
    endLabel.textContent   = d || '--';

    if(!s || !d){ statusEl.textContent='Start/End not found. You can pick them on the map.'; return; }

    // Geocode
    statusEl.textContent='Geocoding…';
    start = await geocode(s); end = await geocode(d);
    if(!start || !end){ statusEl.textContent='Geocoding failed. Edit JSON or pick on map.'; return; }
    addMarker('start',start); addMarker('end',end);

    // Build route
    statusEl.textContent='Building route…';
    await buildRoute();
    statusEl.textContent='Done.'; buildBtn.disabled=false; saveBtn.disabled=false;
  } catch(err){
    console.error(err); statusEl.textContent='Something went wrong. Try a clearer photo.';
  } finally {
    reRunBtn.disabled = false;
  }
}

/* ========== Parsers ========== */
function parseSimple(text){
  const lines=text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  const out={format:'simple', start:null, end:null, steps:[]};
  for(const l of lines){
    if(/^START:/i.test(l)) out.start=l.replace(/^START:/i,'').trim();
    else if(/^END:/i.test(l)) out.end=l.replace(/^END:/i,'').trim();
    else if(/^Origin:/i.test(l)) out.start=l.replace(/^Origin:/i,'').trim();
    else if(/^Final Destination:/i.test(l)) out.end=l.replace(/^Final Destination:/i,'').trim();
    else if(/^[-•]/.test(l)) out.steps.push({text:l.replace(/^[-•]\s?/,'').trim()});
  }
  return out;
}
function parseWy(text){
  if(!/Final Destination:/i.test(text)) return null;
  const out={format:'wy_permit', origin:null, destination:null, rows:[]};
  const o=text.match(/Origin:\s*(.+)/i); if(o) out.origin=o[1].trim();
  const d=text.match(/Final Destination:\s*(.+)/i); if(d) out.destination=d[1].trim();
  const lines=text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  const h=lines.findIndex(l=>/Miles/i.test(l)&&/Route/i.test(l)&&/Directions/i.test(l));
  if(h===-1) return out;
  for(let i=h+1;i<lines.length;i++){
    const line=lines[i]; if(/Final Destination/i.test(line)) break;
    const m=line.match(/^(\d+(\.\d+)?)/); if(!m) continue;
    const miles=parseFloat(m[1]);
    const rest=line.replace(/^(\d+(\.\d+)?)/,'').trim();
    const parts=rest.split(/\s{2,}/);
    const route=(parts[0]||rest.split(/\s+/)[0]||'').trim();
    const directions=(parts.length>=2?parts.slice(1).join('  '):rest.replace(route,'')).trim();
    out.rows.push({miles,route,directions});
  }
  return out;
}

/* ========== Geocode & Routing ========== */
async function geocode(q){
  const url=`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(q)}.json?limit=1&country=US&access_token=${mapboxgl.accessToken}`;
  const r=await fetch(url); const j=await r.json();
  const f=j?.features?.[0]; return f?.center?{lng:f.center[0], lat:f.center[1]}:null;
}

document.getElementById('pickStart').onclick=()=>clickMode='start';
document.getElementById('pickEnd').onclick=()=>clickMode='end';
document.getElementById('addWp').onclick=()=>clickMode='wp';
document.getElementById('clearWp').onclick=()=>{
  waypoints=[]; wpMarkers.forEach(m=>m.remove()); wpMarkers=[]; clearRoute();
};

buildBtn.addEventListener('click', buildRoute);

async function buildRoute(){
  if(!start||!end){ alert('Set start and end first.'); return; }
  clearRoute();
  const coords=[start,...waypoints,end].map(p=>`${p.lng},${p.lat}`).join(';');
  const url=`https://api.mapbox.com/directions/v5/mapbox/driving/${coords}?geometries=geojson&overview=full&steps=true&access_token=${mapboxgl.accessToken}`;
  const r=await fetch(url); const j=await r.json();
  const route=j?.routes?.[0]; const geom=route?.geometry; if(!geom){ alert('No route found.'); return; }
  map.addSource('route',{type:'geojson', data:{type:'Feature', geometry:geom}});
  map.addLayer({id:'route', type:'line', source:'route', paint:{'line-width':5,'line-color':'#0a84ff'}});
  const b=new mapboxgl.LngLatBounds(); geom.coordinates.forEach(c=>b.extend(c)); map.fitBounds(b,{padding:30});
  renderSteps(route.legs?.flatMap(l=>l.steps)||[]);
}

function renderSteps(steps){
  stepsEl.innerHTML=''; steps.forEach((s,i)=>{ const li=document.createElement('li'); li.textContent=s.maneuver?.instruction||`Step ${i+1}`; stepsEl.appendChild(li); });
}

/* ========== Save ========== */
saveBtn.addEventListener('click', ()=>{
  try{
    const record={
      id:'r_'+Math.random().toString(36).slice(2),
      name: prompt('Route name:', 'Permit Route') || 'Permit Route',
      createdAt:new Date().toISOString(),
      start,end,waypoints,
      ocrText: ocrText.value,
      parsed: JSON.parse(parsedBox.value||'{}')
    };
    const KEY='mmp_routes'; const list=JSON.parse(localStorage.getItem(KEY)||'[]');
    list.unshift(record); localStorage.setItem(KEY, JSON.stringify(list));
    alert('Saved! Check Routes.');
  }catch(e){ console.error(e); alert('Could not save.'); }
});

/* ========== Edit JSON toggle ========== */
editParsedBtn.addEventListener('click', ()=>{
  const ro=parsedBox.hasAttribute('readonly');
  if(ro){ parsedBox.removeAttribute('readonly'); parsedBox.focus(); editParsedBtn.textContent='Lock JSON'; }
  else { parsedBox.setAttribute('readonly','readonly'); editParsedBtn.textContent='Edit JSON'; }
});
</script>
</body>
</html>