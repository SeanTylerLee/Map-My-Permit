<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Submit Permit • Map My Permit</title>
  <link rel="stylesheet" href="styles.css" />

  <!-- Mapbox -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <!-- Tesseract OCR -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>
<body>
  <!-- Header -->
  <header class="app-header">
    <img class="app-logo" src="images/logo.png" alt="Logo" />
    <h1 class="app-title">Submit Permit</h1>
    <a class="icon-btn" href="index.html" aria-label="Home">
      <img src="images/home.png" alt="Home" />
    </a>
  </header>

  <main class="content">
    <!-- Upload Section -->
    <section class="card">
      <h2 class="section-title">Upload or Take Photo</h2>
      <input id="fileInput" type="file" accept="image/*" />
      <div class="preview-wrap"><img id="preview" alt="Preview" /></div>
      <p id="status" class="muted small">Select a clear photo of the permit.</p>
      <div class="row">
        <button id="reRunBtn" class="ghost-btn" disabled>Re-run OCR</button>
        <button id="clearBtn" class="ghost-btn">Clear</button>
      </div>
    </section>

    <!-- OCR Results -->
    <section class="card">
      <h2 class="section-title">Detected Text</h2>
      <textarea id="ocrText" class="mono" rows="8" readonly placeholder="OCR results will appear here…"></textarea>
    </section>

    <!-- Parsed Permit Steps -->
    <section class="card">
      <h2 class="section-title">Parsed Route (Permit Only)</h2>
      <div class="row small">
        <label class="chip">Start: <span id="startLabel" class="bold">--</span></label>
        <label class="chip">End: <span id="endLabel" class="bold">--</span></label>
      </div>
      <textarea id="parsedBox" class="mono" rows="8" readonly></textarea>
      <div class="row">
        <button id="editParsedBtn" class="ghost-btn">Edit JSON</button>
        <button id="buildBtn" class="primary-btn" disabled>Build Route (Permit)</button>
        <button id="saveBtn" class="ghost-btn" disabled>Save</button>
      </div>
      <details class="small" style="margin-top:.5rem;">
        <summary>Waypoint debug</summary>
        <ul id="wpDebug" class="small"></ul>
      </details>
    </section>

    <!-- Map & Directions -->
    <section class="card">
      <h2 class="section-title">Map & Steps</h2>
      <div id="map" class="map"></div>
      <ol id="steps" class="small" style="margin-top:10px;padding-left:18px;"></ol>
      <div class="chip-row">
        <button id="pickStart" class="chip">Pick Start</button>
        <button id="pickEnd" class="chip">Pick End</button>
      </div>
    </section>
  </main>

  <!-- Spacer -->
  <div style="height: 96px;"></div>

  <!-- Bottom Nav -->
  <nav class="tabbar">
    <a class="tab" href="index.html"><img src="images/home.png" alt=""><span>Home</span></a>
    <a class="tab" href="routes.html"><img src="images/settings.png" alt=""><span>Routes</span></a>
  </nav>

<script>
mapboxgl.accessToken = 'YOUR_MAPBOX_TOKEN';

/* DOM Elements */
const fileInput   = document.getElementById('fileInput');
const preview     = document.getElementById('preview');
const statusEl    = document.getElementById('status');
const reRunBtn    = document.getElementById('reRunBtn');
const clearBtn    = document.getElementById('clearBtn');

const ocrText     = document.getElementById('ocrText');
const parsedBox   = document.getElementById('parsedBox');
const startLabel  = document.getElementById('startLabel');
const endLabel    = document.getElementById('endLabel');

const buildBtn    = document.getElementById('buildBtn');
const saveBtn     = document.getElementById('saveBtn');
const editParsedBtn = document.getElementById('editParsedBtn');

const stepsEl     = document.getElementById('steps');
const wpDebug     = document.getElementById('wpDebug');

let start=null, end=null, map, startMarker, endMarker;
map = new mapboxgl.Map({ container:'map', style:'mapbox://styles/mapbox/streets-v12', center:[-104.99,41.14], zoom:6 });
map.addControl(new mapboxgl.NavigationControl(), 'top-right');

/* Upload → OCR → Parse */
fileInput.addEventListener('change', async ()=>{
  const f=fileInput.files?.[0]; if(!f) return;
  preview.src = URL.createObjectURL(f);
  reRunBtn.disabled = false;
  await runPipeline(f);
});
reRunBtn.addEventListener('click', async ()=>{
  const f=fileInput.files?.[0]; if(!f) return;
  await runPipeline(f);
});
clearBtn.addEventListener('click', resetAll);

async function runPipeline(file){
  try{
    setStatus('Running OCR…', true);
    const { data } = await Tesseract.recognize(file,'eng',{
      logger:m=>{ if(m.status && m.progress!=null){ setStatus(`${m.status.replace(/_/g,' ')} ${Math.round(m.progress*100)}%`, true); } }
    });
    const text=(data?.text||'').trim();
    ocrText.value=text;

    setStatus('Parsing permit…', true);
    const parsed = parseWy(text);
    parsedBox.value = JSON.stringify(parsed, null, 2);

    startLabel.textContent = parsed.origin || '--';
    endLabel.textContent   = parsed.destination || '--';

    start = parsed.origin ? await geocode(parsed.origin) : null;
    end   = parsed.destination ? await geocode(parsed.destination) : null;

    buildBtn.disabled = !(start && end);
    setStatus(start && end ? 'Ready to build permit route.' : 'Set both start and end.', false);
  } catch(e){
    console.error(e);
    setStatus('Error: Try a clearer photo.', false);
  } finally {
    reRunBtn.disabled = false;
  }
}

/* Wyoming Permit Parser */
function parseWy(text){
  const out={format:'wy_permit', origin:null, destination:null, rows:[]};
  const o=text.match(/Origin:\s*(.+)/i); if(o) out.origin=o[1].trim();
  const d=text.match(/Final Destination:\s*(.+)/i); if(d) out.destination=d[1].trim();
  const lines=text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  const h=lines.findIndex(l=>/Miles/i.test(l)&&/Route/i.test(l)&&/Directions/i.test(l));
  if(h===-1) return out;
  for(let i=h+1;i<lines.length;i++){
    if(/Final Destination/i.test(lines[i])) break;
    const cols=lines[i].split(/\s{2,}/);
    if(cols.length>=3){
      out.rows.push({ miles:cols[0], route:cols[1], directions:cols[2] });
    }
  }
  return out;
}

/* Build Route */
buildBtn.addEventListener('click', async ()=>{
  const parsed = JSON.parse(parsedBox.value);
  if (!parsed) return alert('Invalid parsed JSON.');
  if (!start || !end) return alert('Set start and end first.');

  const waypoints = [];
  for (let i=0; i<parsed.rows.length; i++){
    const step = parsed.rows[i];
    if(step.route && step.directions){
      const label = `${step.route} ${step.directions}`;
      const coord = await geocode(label);
      if(coord){
        waypoints.push(coord);
        addWpDebug(label, true);
      } else {
        addWpDebug(label, false);
      }
    }
  }
  await drawRoute(start, waypoints, end);
});

/* Debug list */
function addWpDebug(label, ok){
  const li = document.createElement('li');
  li.textContent = (ok ? '✓ ' : '✕ ') + label;
  li.style.color = ok ? 'black' : 'red';
  wpDebug.appendChild(li);
}

/* Geocode helper */
async function geocode(q){
  const url=`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(q)}.json?limit=1&country=US&access_token=${mapboxgl.accessToken}`;
  try{ const r=await fetch(url); const j=await r.json();
    const f=j?.features?.[0]; return f?.center?{lng:f.center[0], lat:f.center[1]}:null;
  }catch{ return null; }
}

/* Draw route */
async function drawRoute(start, wps, end){
  if (map.getSource('route')){ map.removeLayer('route'); map.removeSource('route'); }
  stepsEl.innerHTML='';
  const seq = [start, ...(wps||[]), end];
  const coords = seq.map(p=>`${p.lng},${p.lat}`).join(';');
  const url=`https://api.mapbox.com/directions/v5/mapbox/driving/${coords}?geometries=geojson&overview=full&steps=true&access_token=${mapboxgl.accessToken}`;
  const r=await fetch(url); const j=await r.json();
  const route=j?.routes?.[0];
  if(!route) return alert('No route found.');
  map.addSource('route',{type:'geojson', data:{type:'Feature', geometry:route.geometry}});
  map.addLayer({id:'route', type:'line', source:'route', paint:{'line-width':5,'line-color':'#0a84ff'}});
  const b=new mapboxgl.LngLatBounds(); route.geometry.coordinates.forEach(c=>b.extend(c)); map.fitBounds(b,{padding:30});
  route.legs.forEach(l=>l.steps.forEach(s=>{
    const li=document.createElement('li');
    li.textContent = s.maneuver?.instruction || '';
    stepsEl.appendChild(li);
  }));
  saveBtn.disabled = false;
}

/* Misc */
function resetAll(){
  fileInput.value=''; preview.removeAttribute('src'); ocrText.value=''; parsedBox.value='';
  startLabel.textContent=endLabel.textContent='--'; wpDebug.innerHTML=''; stepsEl.innerHTML='';
  if(startMarker) startMarker.remove(); if(endMarker) endMarker.remove();
  buildBtn.disabled = true; saveBtn.disabled = true;
  setStatus('Select a clear photo of the permit.', false);
}
function setStatus(msg){ statusEl.textContent = msg; }
editParsedBtn.addEventListener('click', ()=>{
  if(parsedBox.hasAttribute('readonly')){ parsedBox.removeAttribute('readonly'); editParsedBtn.textContent='Lock JSON'; }
  else { parsedBox.setAttribute('readonly','readonly'); editParsedBtn.textContent='Edit JSON'; }
});
</script>
</body>
</html>