<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Route Navigation</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="styles.css" />
  <style>
    #map {
      height: 80vh;
      margin-top: 10px;
      border-radius: 10px;
    }

    #routeInstructions {
      margin-top: 1rem;
      background: #eee;
      padding: 10px;
      border-radius: 8px;
      font-family: monospace;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <header>
    <h1>Map Navigation</h1>
  </header>

  <main class="container">
    <div id="map"></div>
    <div id="routeInstructions">Route instructions will appear here...</div>
  </main>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  const routeText = JSON.parse(localStorage.getItem("parsedRoute") || "[]");
  document.getElementById("routeInstructions").textContent = routeText.join('\n');

  const map = L.map('map').setView([35.5, -97.5], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
  }).addTo(map);

  const fakePoints = {
    "US-69": [35.435, -94.396],
    "I-40": [35.4676, -97.5164],
    "I-44": [36.154, -95.9928],
    "US-75": [36.13, -95.9],
    "OK-51": [36.1, -96.0],
    "US-412": [36.13, -95.8]
  };

  async function fakeGeocode(routeLines) {
    const points = [];
    for (const line of routeLines) {
      for (const key in fakePoints) {
        if (line.includes(key)) {
          points.push({ coords: fakePoints[key], instruction: line });
          break;
        }
      }
    }
    if (points.length < 2) {
      points.push({ coords: [35.435, -94.396], instruction: "Start" });
      points.push({ coords: [35.4676, -97.5164], instruction: "End" });
    }
    return points;
  }

  function speak(text) {
    if (!'speechSynthesis' in window) return;
    const utterance = new SpeechSynthesisUtterance(text);
    speechSynthesis.speak(utterance);
  }

  // GPS + Voice Guidance Logic
  fakeGeocode(routeText).then(waypoints => {
    if (waypoints.length > 0) {
      const latLngs = waypoints.map(w => w.coords);
      const polyline = L.polyline(latLngs, { color: 'blue', weight: 5 }).addTo(map);
      map.fitBounds(polyline.getBounds());

      waypoints.forEach(w =>
        L.circleMarker(w.coords, { radius: 5, color: 'red', fillColor: 'red', fillOpacity: 0.9 }).addTo(map)
      );

      let currentIndex = 0;
      const spoken = new Set();

      if ("geolocation" in navigator) {
        navigator.geolocation.watchPosition(
          (pos) => {
            const { latitude, longitude } = pos.coords;

            // Place GPS dot
            if (window.gpsMarker) map.removeLayer(window.gpsMarker);
            window.gpsMarker = L.circleMarker([latitude, longitude], {
              radius: 6,
              color: 'green',
              fillColor: 'lime',
              fillOpacity: 1
            }).addTo(map);
            map.setView([latitude, longitude], 15);

            const userLoc = L.latLng(latitude, longitude);

            for (let i = currentIndex; i < waypoints.length; i++) {
              const wp = L.latLng(waypoints[i].coords);
              const dist = userLoc.distanceTo(wp); // meters

              if (dist < 500 && !spoken.has(i)) {
                speak(waypoints[i].instruction);
                spoken.add(i);
                currentIndex = i + 1;
                break;
              }
            }
          },
          (err) => console.warn("GPS error:", err),
          { enableHighAccuracy: true, maximumAge: 5000 }
        );
      } else {
        alert("GPS not supported in this browser.");
      }
    }
  });
</script>
  

  
  
</body>
</html>