<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Map Navigation</title>
  <link href="https://unpkg.com/leaflet/dist/leaflet.css" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css" />
  <style>
    #map {
      height: 70vh;
      margin-top: 10px;
      border-radius: 10px;
    }

    #routeInstructions {
      margin-top: 1rem;
      background: #eee;
      padding: 10px;
      border-radius: 8px;
      font-family: monospace;
      white-space: pre-wrap;
    }

    button {
      margin-top: 10px;
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      background-color: #007aff;
      color: white;
    }

    button:nth-of-type(2) {
      background-color: #34c759;
    }
  </style>
</head>
<body>
  <header>
    <h1>Map Navigation</h1>
  </header>

  <main class="container">
    <div id="map"></div>
    <button id="viewRouteBtn">üëÅÔ∏è View Route</button>
    <button id="enableGPSBtn">üìç Re-enable GPS</button>
    <div id="routeInstructions">Route instructions will appear here...</div>
  </main>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const MAPBOX_TOKEN = "pk.eyJ1Ijoic2VhbmxlZTkyIiwiYSI6ImNtZTAyeG0wbzAwamgybHE2cmwzenJtM2cifQ.DE8FeoDvc3EzuyR5uPopzA";
    const routeText = JSON.parse(localStorage.getItem("parsedRoute") || "[]");
    const instructionBox = document.getElementById("routeInstructions");

    let gpsCentering = true;

    document.getElementById('viewRouteBtn').addEventListener('click', () => {
      gpsCentering = false;
      alert("GPS auto-centering disabled. You can zoom and pan freely.");
    });

    document.getElementById('enableGPSBtn').addEventListener('click', () => {
      gpsCentering = true;
      alert("GPS auto-centering re-enabled.");
    });

    const map = L.map('map').setView([35.5, -97.5], 6);
    L.tileLayer(`https://api.mapbox.com/styles/v1/mapbox/streets-v11/tiles/{z}/{x}/{y}?access_token=${MAPBOX_TOKEN}`, {
      maxZoom: 18,
      tileSize: 512,
      zoomOffset: -1,
      attribution: '&copy; <a href="https://www.mapbox.com/">Mapbox</a>'
    }).addTo(map);

    const waypoints = [];

    const geocodeStep = async (step) => {
      const res = await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(step)}.json?access_token=${MAPBOX_TOKEN}`);
      const data = await res.json();
      if (data.features && data.features.length > 0) {
        const [lon, lat] = data.features[0].center;
        waypoints.push({ lat, lon, instruction: step });
      }
    };

    const buildRoute = async () => {
      for (const step of routeText) {
        await geocodeStep(step);
      }

      if (waypoints.length < 2) {
        alert("Could not geocode enough route points. Try editing permit text.");
        return;
      }

      const coords = waypoints.map(wp => `${wp.lon},${wp.lat}`).join(';');
      const directionsURL = `https://api.mapbox.com/directions/v5/mapbox/driving-traffic/${coords}?geometries=geojson&steps=true&access_token=${MAPBOX_TOKEN}`;
      const routeRes = await fetch(directionsURL);
      const routeData = await routeRes.json();

      if (!routeData.routes || routeData.routes.length === 0) {
        alert("Mapbox couldn't build a route.");
        return;
      }

      const route = routeData.routes[0];
      const geometry = route.geometry.coordinates;
      const steps = route.legs.flatMap(leg => leg.steps.map(s => s.maneuver.instruction));

      const latLngs = geometry.map(([lon, lat]) => [lat, lon]);
      const polyline = L.polyline(latLngs, { color: 'blue', weight: 5 }).addTo(map);
      map.fitBounds(polyline.getBounds());

      waypoints.forEach(({ lat, lon }) => {
        L.circleMarker([lat, lon], {
          radius: 5,
          color: 'red',
          fillColor: 'red',
          fillOpacity: 0.9
        }).addTo(map);
      });

      let spokenSet = new Set();
      function speak(text) {
        if (!('speechSynthesis' in window)) return;
        const utter = new SpeechSynthesisUtterance(text);
        speechSynthesis.speak(utter);
      }

      instructionBox.textContent = steps.join('\n');

      if ('geolocation' in navigator) {
        navigator.geolocation.watchPosition(
          (pos) => {
            const { latitude, longitude } = pos.coords;

            if (window.gpsMarker) map.removeLayer(window.gpsMarker);
            window.gpsMarker = L.circleMarker([latitude, longitude], {
              radius: 6,
              color: 'green',
              fillColor: 'lime',
              fillOpacity: 1
            }).addTo(map);

            if (gpsCentering) {
              map.setView([latitude, longitude], 15);
            }

            const userLoc = L.latLng(latitude, longitude);
            waypoints.forEach((wp, i) => {
              const dist = userLoc.distanceTo([wp.lat, wp.lon]);
              if (dist < 300 && !spokenSet.has(i)) {
                speak(wp.instruction);
                spokenSet.add(i);
              }
            });
          },
          (err) => console.warn("GPS error:", err),
          { enableHighAccuracy: true, maximumAge: 5000 }
        );
      } else {
        alert("GPS not supported.");
      }
    };

    buildRoute();
  </script>
</body>
</html>