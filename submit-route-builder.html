<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Basic PWA/iOS meta -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Build Routes • Map My Permit</title>

  <!-- Your shared styles (we add a few classes at the end of this message) -->
  <link rel="stylesheet" href="styles.css" />

  <!-- Mapbox GL -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
</head>
<body class="full-screen">
  <!-- ===== Header bar (title + GO) ===== -->
  <header class="maps-header">
    <!-- Back / share placeholder -->
    <button class="hdr-btn" id="hdrBack" title="Back">〈</button>

    <!-- Title in the middle -->
    <div class="hdr-title" id="routeTitle">Build Route</div>

    <!-- GO button starts nav -->
    <button class="hdr-btn go" id="goBtn" disabled>Go ⟩</button>
  </header>

  <!-- ===== Full-screen Map ===== -->
  <div id="map" class="map-full" aria-label="Route builder map"></div>

  <!-- ===== Distance/Time callout bubble ===== -->
  <div id="routeBubble" class="route-bubble" hidden>
    <div id="bubbleDistance">--</div>
    <div id="bubbleTime" class="muted small">--</div>
  </div>

  <!-- ===== Right-side tool stack ===== -->
  <div class="tool-stack">
    <button class="tool" id="toolDraw" title="Add points by tapping map">Draw</button>
    <button class="tool" id="toolInfo" title="Points list">Info</button>
    <button class="tool" id="toolLocate" title="Center on me">Location</button>
    <button class="tool" id="toolCharts" title="(stub)">Charts</button>
  </div>

  <!-- ===== Bottom toolbar (visual only for now) ===== -->
  <nav class="maps-tabbar">
    <button class="tab-item" id="tabRoute">Route</button>
    <button class="tab-item" id="tabSearch">Search</button>
    <button class="tab-item" id="tabFavs">Favorites</button>
    <button class="tab-item" id="tabTurns">Turns</button>
    <button class="tab-item" id="tabMore">More</button>
  </nav>

  <!-- ===== Slide-up info panel (edit/reorder/delete) ===== -->
  <aside class="info-panel" id="infoPanel" hidden>
    <div class="panel-header">
      <div class="panel-title">Route Points</div>
      <button class="chip" id="panelClose">Close</button>
    </div>
    <ol id="pointList" class="point-list"></ol>
    <div class="row" style="margin-top:8px;">
      <button class="ghost-btn" id="btnClear">Clear</button>
      <button class="ghost-btn" id="btnUndo">Undo</button>
    </div>
  </aside>

<script>
/* ============================================================
   CONFIG (keep your token)
============================================================ */
mapboxgl.accessToken = 'pk.eyJ1Ijoic2VhbmxlZTkyIiwiYSI6ImNtZTAyeG0wbzAwamgybHE2cmwzenJtM2cifQ.DE8FeoDvc3EzuyR5uPopzA';

/* ============================================================
   MAP INIT
============================================================ */
const map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/navigation-day-v1', // nav-friendly style
  center: [-99.5, 36.7],  // OK/KS area like your screenshot
  zoom: 6
});
map.addControl(new mapboxgl.NavigationControl(), 'top-right');
window.addEventListener('resize', () => map.resize());

/* ============================================================
   STATE
============================================================ */
let start = null, end = null;          // {lng,lat}
let wps = [];                          // waypoint array
let mkStart = null, mkEnd = null;      // markers
let mkWps = [];                        // waypoint markers
let drawing = false;                   // draw mode toggle
let routeFeature = null;               // drawn route feature
let steps = [];                        // steps from Directions API
let stepIdx = 0;                       // index into steps
let userMarker = null;                 // blue "me" dot
let watchId = null;                    // geolocation watch id
let follow = true;                     // camera follow while navigating

/* ============================================================
   DOM
============================================================ */
const goBtn          = document.getElementById('goBtn');
const toolDraw       = document.getElementById('toolDraw');
const toolInfo       = document.getElementById('toolInfo');
const toolLocate     = document.getElementById('toolLocate');

const infoPanel      = document.getElementById('infoPanel');
const panelClose     = document.getElementById('panelClose');
const pointList      = document.getElementById('pointList');
const btnClear       = document.getElementById('btnClear');
const btnUndo        = document.getElementById('btnUndo');

const bubble         = document.getElementById('routeBubble');
const bubbleDistance = document.getElementById('bubbleDistance');
const bubbleTime     = document.getElementById('bubbleTime');

/* ============================================================
   MAP TAPS (Draw mode)
   - Tap = Start if none, else Waypoint
   - Long-press (contextmenu) = End
============================================================ */
map.on('click', (e) => {
  if (!drawing) return;
  if (!start) setStart(e.lngLat);
  else addWaypoint(e.lngLat);
  updateList(); updateGoState(); maybeBuildRoute();
});

map.on('contextmenu', (e) => {
  if (!drawing) return;
  setEnd(e.lngLat);
  updateList(); updateGoState(); maybeBuildRoute();
});

/* Pause follow if the user pans/zooms */
map.on('dragstart', ()=> { follow = false; });
map.on('zoomstart', ()=> { follow = false; });

/* ============================================================
   MARKERS (start / waypoint / end)
============================================================ */
function setStart(ll){
  start = ll;
  if (!mkStart) mkStart = new mapboxgl.Marker({ color:'#1fba4a' });
  mkStart.setLngLat(ll).addTo(map).setPopup(new mapboxgl.Popup({offset:12}).setText('Start'));
}

function addWaypoint(ll){
  wps.push(ll);
  const n = wps.length;

  // custom numbered badge
  const el = document.createElement('div');
  el.className = 'wp-badge-pin';
  el.textContent = n;

  const m = new mapboxgl.Marker(el).setLngLat(ll).addTo(map);

  // popup with live distance + delete
  const pid = `d_${n}`;
  const html = `
    <div class="popup-title">Waypoint ${n}</div>
    <div class="popup-sub" id="${pid}">Distance: --</div>
    <button class="chip danger" onclick="window.__delWp(${n-1})">Delete</button>`;
  m.setPopup(new mapboxgl.Popup({offset:12}).setHTML(html));
  m.getElement().addEventListener('click', ()=> updateDistanceLabel(pid, ll));

  mkWps.push(m);
  window.__delWp = deleteWaypoint; // expose for popup button
}

function setEnd(ll){
  end = ll;
  if (!mkEnd) mkEnd = new mapboxgl.Marker({ color:'#ff3b30' });
  mkEnd.setLngLat(ll).addTo(map).setPopup(new mapboxgl.Popup({offset:12}).setText('End'));
}

function renumberWpMarkers(){ mkWps.forEach((m,i)=> m.getElement().textContent = (i+1)); }

/* ============================================================
   INFO PANEL (list + reorder + delete)
============================================================ */
function updateList(){
  pointList.innerHTML = '';

  // Start
  pointList.appendChild(rowStatic(start ? 'Start' : 'Start: --'));

  // Waypoints
  wps.forEach((pt,i)=>{
    pointList.appendChild(rowWp(i));
  });

  // End
  pointList.appendChild(rowStatic(end ? 'End' : 'End: --'));
}

function rowStatic(text){
  const li = document.createElement('li');
  li.textContent = text;
  return li;
}

function rowWp(i){
  const li = document.createElement('li');
  li.className = 'point-row';
  li.innerHTML = `
    <span>Waypoint ${i+1}</span>
    <span class="point-actions">
      <button class="chip" onclick="window.__moveWp(${i},-1)">↑</button>
      <button class="chip" onclick="window.__moveWp(${i},1)">↓</button>
      <button class="chip danger" onclick="window.__delWp(${i})">Delete</button>
    </span>`;
  window.__moveWp = moveWaypoint;
  window.__delWp  = deleteWaypoint;
  return li;
}

function moveWaypoint(i, dir){
  const j = i + dir;
  if (j < 0 || j >= wps.length) return;
  [wps[i], wps[j]] = [wps[j], wps[i]];
  [mkWps[i], mkWps[j]] = [mkWps[j], mkWps[i]];
  renumberWpMarkers();
  updateList(); maybeBuildRoute();
}

function deleteWaypoint(i){
  const m = mkWps.splice(i,1)[0];
  if (m) m.remove();
  wps.splice(i,1);
  renumberWpMarkers();
  updateList(); maybeBuildRoute();
}

/* Panel controls */
toolInfo.addEventListener('click', ()=>{ infoPanel.hidden = !infoPanel.hidden; updateList(); });
panelClose.addEventListener('click', ()=> infoPanel.hidden = true);

/* ============================================================
   TOOLS: Draw toggle / Locate / Clear / Undo
============================================================ */
toolDraw.addEventListener('click', ()=>{
  drawing = !drawing;
  toolDraw.classList.toggle('tool-active', drawing);
  toolDraw.textContent = drawing ? 'Drawing…' : 'Draw';
});
toolLocate.addEventListener('click', ()=>{
  follow = true;
  if (userMarker && userMarker.getLngLat()){
    map.easeTo({ center: userMarker.getLngLat(), duration: 600, zoom: Math.max(14, map.getZoom()) });
  }
});

btnUndo.addEventListener('click', undoLast);
btnClear.addEventListener('click', clearAll);

function undoLast(){
  if (end){ mkEnd.remove(); mkEnd=null; end=null; }
  else if (wps.length){ deleteWaypoint(wps.length-1); }
  else if (start){ mkStart.remove(); mkStart=null; start=null; }
  updateList(); updateGoState(); maybeBuildRoute();
}

function clearAll(){
  stopNav();
  removeRoute();
  if (mkStart){ mkStart.remove(); mkStart=null; }
  if (mkEnd){ mkEnd.remove(); mkEnd=null; }
  mkWps.forEach(m=>m.remove()); mkWps=[];
  start=end=null; wps=[];
  bubble.hidden = true;
  updateList(); updateGoState();
}

/* ============================================================
   ROUTE BUILD + SUMMARY BUBBLE
============================================================ */
function updateGoState(){ goBtn.disabled = !(start && end); }

async function maybeBuildRoute(){
  bubble.hidden = true;
  removeRoute();
  if (!(start && end)) return;

  // Build the coordinates string for Directions API
  const all = [start, ...wps, end]
    .map(p => `${p.lng.toFixed(6)},${p.lat.toFixed(6)}`).join(';');

  const url = `https://api.mapbox.com/directions/v5/mapbox/driving/${all}?geometries=geojson&overview=full&steps=true&annotations=duration,distance&access_token=${mapboxgl.accessToken}`;

  const res = await fetch(url);
  const json = await res.json();
  const route = json?.routes?.[0];
  if (!route) return;

  // Draw route polyline
  routeFeature = { type:'Feature', geometry: route.geometry };
  map.addSource('route', { type:'geojson', data: routeFeature });
  map.addLayer({
    id:'route',
    type:'line',
    source:'route',
    paint:{ 'line-width': 6, 'line-color': '#0a84ff' }
  });

  // Fit bounds to the route
  const b = new mapboxgl.LngLatBounds();
  route.geometry.coordinates.forEach(c => b.extend(c));
  map.fitBounds(b, { padding: 60, duration: 500 });

  // Summary bubble (distance/time)
  const mi = Math.round(route.distance / 1609.34);
  const mins = Math.round(route.duration / 60);
  bubbleDistance.textContent = `${mi} mi`;
  bubbleTime.textContent = mins >= 60
    ? `${Math.floor(mins/60)} hrs, ${mins%60} min`
    : `${mins} min`;
  bubble.hidden = false;

  // Save steps for navigation
  steps = (route.legs||[]).flatMap(l=>l.steps||[]);
  stepIdx = 0;
}

/* Remove route layer/source if present */
function removeRoute(){
  if (map.getSource('route')){ map.removeLayer('route'); map.removeSource('route'); }
  routeFeature = null;
}

/* ============================================================
   NAVIGATION (voice + banner + follow camera)
============================================================ */
goBtn.addEventListener('click', ()=>{
  if (!start || !end) return;
  follow = true;
  startNav();
});

function startNav(){
  // Ensure user marker exists
  if (!userMarker){
    const dot = document.createElement('div');
    dot.className = 'me-dot';
    userMarker = new mapboxgl.Marker(dot).setLngLat(start).addTo(map);
  }
  // Begin GPS watch
  if (navigator.geolocation){
    watchId = navigator.geolocation.watchPosition(onPos, ()=>{}, { enableHighAccuracy:true, maximumAge:2000, timeout:10000 });
  }
  speak('Navigation started');
}

function stopNav(){
  if (watchId != null){ navigator.geolocation.clearWatch(watchId); watchId = null; }
}

/* GPS callback: update marker, advance steps, keep banner fresh */
function onPos(pos){
  const here = { lng: pos.coords.longitude, lat: pos.coords.latitude };
  userMarker.setLngLat(here);

  const step = steps[stepIdx];
  if (!step){ speak('Arrived'); stopNav(); return; }

  const target = { lng: step.maneuver.location[0], lat: step.maneuver.location[1] };
  const meters = haversine(here, target);

  bubbleDistance.textContent = formatDistance(meters);
  bubbleTime.textContent = step.maneuver.instruction || 'Continue';

  if (meters < 35){
    stepIdx++;
    if (steps[stepIdx]) speak(steps[stepIdx].maneuver.instruction);
    else { speak('Arrived'); stopNav(); }
  }

  if (follow){
    map.easeTo({ center: here, duration: 700, zoom: Math.max(14, map.getZoom()) });
  }
}

/* Waypoint popup distance label (from me → fallback to start) */
function updateDistanceLabel(elId, target){
  const src = (userMarker && userMarker.getLngLat()) || start;
  if (!src) return;
  const d = haversine({lng:src.lng, lat:src.lat}, target);
  const el = document.getElementById(elId);
  if (el) el.textContent = `Distance: ${formatDistance(d)}`;
}

/* ============================================================
   UTILITIES
============================================================ */
function haversine(a,b){
  const toRad = d => d * Math.PI / 180, R = 6371000;
  const dLat = toRad(b.lat - a.lat), dLng = toRad(b.lng - a.lng);
  const s1 = Math.sin(dLat/2), s2 = Math.sin(dLng/2);
  const A = s1*s1 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*s2*s2;
  return 2 * R * Math.asin(Math.sqrt(A));
}
function formatDistance(m){ return (m>=1609.34) ? `${(m/1609.34).toFixed(1)} mi` : `${Math.round(m*3.28084)} ft`; }
function speak(t){ try{ const u=new SpeechSynthesisUtterance(t); window.speechSynthesis.cancel(); window.speechSynthesis.speak(u);}catch{} }
</script>
</body>
</html>