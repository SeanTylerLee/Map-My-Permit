<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Basic PWA/iOS meta -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Route Builder • Map My Permit</title>

  <!-- Shared styles (add the snippet below to your styles.css) -->
  <link rel="stylesheet" href="styles.css" />

  <!-- Mapbox GL JS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
</head>
<body class="full-screen">
  <!-- ===== Navigation banner (shows next instruction) ===== -->
  <div id="navBanner" class="nav-banner" hidden>
    <div id="navPrimary" class="nav-primary">Starting navigation…</div>
    <div id="navSecondary" class="nav-secondary"></div>
  </div>

  <!-- ===== Map ===== -->
  <div id="map" class="map-full" aria-label="Route builder map"></div>

  <!-- ===== Floating map controls ===== -->
  <div class="floating-controls">
    <button id="undoBtn" class="chip" title="Undo last point">Undo</button>
    <button id="clearBtn" class="chip" title="Clear all">Clear</button>
    <button id="resumeBtn" class="chip" title="Resume follow" hidden>Resume</button>
  </div>

  <!-- ===== Bottom action bar ===== -->
  <div class="bottom-bar">
    <div class="mode-note">
      <strong>Tip:</strong> After you set <em>Start</em>, taps default to <em>Waypoint</em>.
    </div>
    <div class="button-row">
      <button id="navigateBtn" class="primary-btn" disabled>Navigate</button>
      <button id="stopBtn" class="ghost-btn" disabled>Stop</button>
    </div>
  </div>

  <!-- ===== Waypoint side sheet (edit, reorder, delete) ===== -->
  <aside class="wp-sheet" id="wpSheet" aria-label="Waypoint list">
    <div class="wp-sheet-header">
      <div class="wp-title">Points</div>
      <button id="toggleSheet" class="chip">Hide</button>
    </div>
    <ul id="wpList" class="wp-list"></ul>
  </aside>
  <button id="showSheet" class="fab chip" title="Show points">Points</button>

  <!-- ===== Click Prompt (appears where you tap the map) ===== -->
  <div id="tapPrompt" class="tap-prompt" hidden>
    <div class="prompt-title">Add point as…</div>
    <div class="prompt-row">
      <button id="asStart" class="chip">Start</button>
      <button id="asWaypoint" class="chip">Waypoint</button>
      <button id="asEnd" class="chip">End</button>
    </div>
    <button id="cancelPrompt" class="ghost-btn small-btn">Cancel</button>
  </div>

<script>
/* ===================== CONFIG ===================== */
mapboxgl.accessToken = 'pk.eyJ1Ijoic2VhbmxlZTkyIiwiYSI6ImNtZTAyeG0wbzAwamgybHE2cmwzenJtM2cifQ.DE8FeoDvc3EzuyR5uPopzA';

/* ===================== MAP INIT ===================== */
const map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/navigation-day-v1',
  center: [-105.5, 42.8],  // WY-ish center
  zoom: 6
});
map.addControl(new mapboxgl.NavigationControl(), 'top-right');

/* Resize safety for orientation/app switching */
window.addEventListener('resize', ()=> map.resize());
document.addEventListener('visibilitychange', ()=> { if (!document.hidden) map.resize(); });

/* ===================== STATE ===================== */
let start = null, end = null;            // {lng, lat}
let waypoints = [];                       // [{lng,lat,name?}]
let markers = { start:null, end:null, wps:[] }; // Mapbox markers
let autoMode = 'start';                   // default prompt mode
let pendingClick = null;                  // last clicked lngLat
let routeGeoJSON = null;                  // drawn route
let watchId = null;                       // geolocation watch
let userMarker = null;                    // live-location marker
let currentSteps = [];                    // Mapbox steps
let stepIndex = 0;                        // pointer
let followPaused = false;                 // camera follow
let followPauseTimer = null;              // resume debounce

/* UI refs */
const tapPrompt = document.getElementById('tapPrompt');
const asStartBtn = document.getElementById('asStart');
const asWaypointBtn = document.getElementById('asWaypoint');
const asEndBtn = document.getElementById('asEnd');
const cancelPrompt = document.getElementById('cancelPrompt');

const navigateBtn = document.getElementById('navigateBtn');
const stopBtn = document.getElementById('stopBtn');
const undoBtn = document.getElementById('undoBtn');
const clearBtn = document.getElementById('clearBtn');
const resumeBtn = document.getElementById('resumeBtn');

const navBanner = document.getElementById('navBanner');
const navPrimary = document.getElementById('navPrimary');
const navSecondary = document.getElementById('navSecondary');

const wpSheet = document.getElementById('wpSheet');
const wpList = document.getElementById('wpList');
const toggleSheet = document.getElementById('toggleSheet');
const showSheet = document.getElementById('showSheet');

/* ===================== TAP → PROMPT ===================== */
map.on('click', (e) => {
  pendingClick = e.lngLat;
  const p = map.project(pendingClick);
  tapPrompt.style.left = `${p.x}px`;
  tapPrompt.style.top  = `${p.y}px`;
  tapPrompt.hidden = false;

  [asStartBtn, asWaypointBtn, asEndBtn].forEach(b=>b.classList.remove('chip-active'));
  if (autoMode==='start') asStartBtn.classList.add('chip-active');
  else asWaypointBtn.classList.add('chip-active');
});

/* ===================== PROMPT ACTIONS ===================== */
asStartBtn.onclick = () => { if(pendingClick){ setStart(pendingClick); autoMode='waypoint'; closePrompt(); } };
asWaypointBtn.onclick = () => { if(pendingClick){ addWaypoint(pendingClick); closePrompt(); } };
asEndBtn.onclick   = () => { if(pendingClick){ setEnd(pendingClick); closePrompt(); } };
cancelPrompt.onclick = closePrompt;
function closePrompt(){ tapPrompt.hidden=true; pendingClick=null; refreshNavState(); }

/* ===================== ADD/SET HELPERS ===================== */
function setStart(ll){
  start = { ...ll, name:'Start' };
  if (!markers.start) markers.start = new mapboxgl.Marker({ color:'#2ecc71' });
  markers.start.setLngLat(ll).addTo(map).setPopup(makePopup('Start'));
  upsertList();
}
function addWaypoint(ll){
  const n = waypoints.length+1;
  const wp = { ...ll, name:`Waypoint ${n}` };
  waypoints.push(wp);

  const el = document.createElement('div');
  el.className = 'wp-dot';
  el.textContent = n;

  const m = new mapboxgl.Marker(el).setLngLat(ll).addTo(map);
  m.setPopup(makeWpPopup(wp, n));
  markers.wps.push(m);

  upsertList();
}
function setEnd(ll){
  end = { ...ll, name:'End' };
  if (!markers.end) markers.end = new mapboxgl.Marker({ color:'#e74c3c' });
  markers.end.setLngLat(ll).addTo(map).setPopup(makePopup('End'));
  upsertList();
}
function renumberWpMarkers(){
  markers.wps.forEach((m, i) => { m.getElement().textContent = (i+1); });
}

/* ===================== POPUPS (distance, actions) ===================== */
function makePopup(title){
  const div = document.createElement('div');
  div.className = 'popup-wrap';
  const h = document.createElement('div');
  h.className = 'popup-title'; h.textContent = title;
  div.appendChild(h);
  return new mapboxgl.Popup({offset:12}).setDOMContent(div);
}
function makeWpPopup(wp, idx){
  const div = document.createElement('div'); div.className='popup-wrap';
  const t = document.createElement('div'); t.className='popup-title'; t.textContent = `Waypoint ${idx}`;
  const d = document.createElement('div'); d.className='popup-sub'; d.textContent = 'Distance: --';

  const row = document.createElement('div'); row.className='popup-row';
  const btnDel = document.createElement('button'); btnDel.className='chip danger'; btnDel.textContent='Delete';
  btnDel.onclick = () => { deleteWaypoint(idx-1); };

  row.appendChild(btnDel);
  div.appendChild(t); div.appendChild(d); div.appendChild(row);

  // Update distance from live GPS (fallback from start)
  updateDistanceLabel(d, wp);

  return new mapboxgl.Popup({offset:12}).setDOMContent(div);
}
function updateDistanceLabel(labelEl, targetLL){
  const here = currentPosition || start;
  if (!here || !targetLL) { labelEl.textContent='Distance: --'; return; }
  const meters = haversine(here, targetLL);
  labelEl.textContent = `Distance: ${formatDistance(meters)}`;
}

/* ===================== WAYPOINT LIST (edit/reorder/delete) ===================== */
function upsertList(){
  wpList.innerHTML = '';

  // Start
  listItem('S', start,  null, null, false);

  // Waypoints
  waypoints.forEach((wp, i)=>{
    listItem(String(i+1), wp,
      ()=> moveWp(i, -1),
      ()=> moveWp(i, 1),
      true,
      ()=> deleteWaypoint(i)
    );
  });

  // End
  listItem('E', end, null, null, false);

  // Enable nav only when start & end present
  refreshNavState();
}

function listItem(tag, point, onUp, onDown, editable, onDelete){
  const li = document.createElement('li');
  li.className = 'wp-item';

  const left = document.createElement('div');
  left.className='wp-left';
  const badge = document.createElement('div'); badge.className='wp-badge'; badge.textContent=tag;
  const name = document.createElement('div'); name.className='wp-name'; name.textContent= point ? (point.name||'') : '--';
  left.appendChild(badge); left.appendChild(name);

  const right = document.createElement('div');
  right.className='wp-right';
  if (editable){
    const up = document.createElement('button'); up.className='chip'; up.textContent='↑'; up.onclick=()=>onUp && onUp();
    const down = document.createElement('button'); down.className='chip'; down.textContent='↓'; down.onclick=()=>onDown && onDown();
    const del = document.createElement('button'); del.className='chip danger'; del.textContent='Delete'; del.onclick=()=>onDelete && onDelete();
    right.appendChild(up); right.appendChild(down); right.appendChild(del);
  }

  li.appendChild(left); li.appendChild(right);
  wpList.appendChild(li);
}

function moveWp(i, dir){
  const j = i+dir;
  if (j<0 || j>=waypoints.length) return;
  [waypoints[i], waypoints[j]] = [waypoints[j], waypoints[i]];
  // swap markers as well
  [markers.wps[i], markers.wps[j]] = [markers.wps[j], markers.wps[i]];
  renumberWpMarkers();
  upsertList();
}

function deleteWaypoint(i){
  waypoints.splice(i,1);
  const m = markers.wps.splice(i,1)[0];
  if (m) m.remove();
  renumberWpMarkers();
  upsertList();
}

/* ===================== UNDO / CLEAR ===================== */
undoBtn.onclick = () => {
  if (end) { markers.end.remove(); markers.end=null; end=null; }
  else if (waypoints.length){ deleteWaypoint(waypoints.length-1); }
  else if (start){ markers.start.remove(); markers.start=null; start=null; autoMode='start'; }
  refreshNavState();
};
clearBtn.onclick = () => {
  removeRoute(); stopNavigation();
  if (markers.start){ markers.start.remove(); markers.start=null; }
  if (markers.end){ markers.end.remove(); markers.end=null; }
  markers.wps.forEach(m=>m.remove()); markers.wps=[];
  start=end=null; waypoints=[]; autoMode='start';
  upsertList();
};

/* ===================== NAV BUTTON ENABLE ===================== */
function refreshNavState(){ navigateBtn.disabled = !(start && end); }

/* ===================== NAVIGATE ===================== */
navigateBtn.onclick = async () => {
  const seq = [start, ...waypoints, end];
  const coords = seq.map(p => `${p.lng.toFixed(6)},${p.lat.toFixed(6)}`).join(';');
  const url = `https://api.mapbox.com/directions/v5/mapbox/driving/${coords}?geometries=geojson&overview=full&steps=true&voice_units=imperial&access_token=${mapboxgl.accessToken}`;

  try{
    const res = await fetch(url);
    const json = await res.json();
    const route = json?.routes?.[0];
    if (!route) { alert('No route found.'); return; }

    drawRoute(route.geometry);
    fitToRoute(route.geometry);
    currentSteps = (route.legs||[]).flatMap(l=>l.steps||[]);
    stepIndex = 0; stopBtn.disabled=false;
    showBanner('Navigation started', nextInstruction());
    speak('Navigation started');

    startNavigation();
  }catch(e){ console.error(e); alert('Could not start navigation.'); }
};

stopBtn.onclick = ()=> { stopNavigation(); showBanner('', ''); };

/* Draw/remove route line */
function drawRoute(geometry){
  removeRoute();
  routeGeoJSON = { type:'Feature', geometry };
  map.addSource('route',{type:'geojson', data:routeGeoJSON});
  map.addLayer({ id:'route', type:'line', source:'route', paint:{ 'line-width':6, 'line-color':'#0a84ff' }});
}
function removeRoute(){
  if (map.getSource('route')){ map.removeLayer('route'); map.removeSource('route'); }
  routeGeoJSON=null;
}
function fitToRoute(geometry){
  const b=new mapboxgl.LngLatBounds(); geometry.coordinates.forEach(c=>b.extend(c));
  map.fitBounds(b,{padding:60, duration:600});
}

/* ===================== LIVE NAV ===================== */
let currentPosition = null;

function startNavigation(){
  // create user dot
  if (!userMarker){
    const dot=document.createElement('div'); dot.className='me-dot';
    userMarker=new mapboxgl.Marker(dot).setLngLat(start).addTo(map);
  }
  // watch GPS
  if (navigator.geolocation){
    watchId = navigator.geolocation.watchPosition(onPos, onPosError, { enableHighAccuracy:true, maximumAge:2000, timeout:10000 });
  }

  // pause follow when user interacts; resume button appears
  const pause = ()=>{
    followPaused = true;
    resumeBtn.hidden = false;
    if (followPauseTimer) clearTimeout(followPauseTimer);
    followPauseTimer = setTimeout(()=>{ /* keep paused until user taps resume */ }, 10000);
  };
  map.on('dragstart', pause); map.on('zoomstart', pause); map.on('rotatestart', pause);
}
function stopNavigation(){
  if (watchId!=null){ navigator.geolocation.clearWatch(watchId); watchId=null; }
  if (userMarker){ userMarker.remove(); userMarker=null; }
  currentSteps=[]; stepIndex=0; stopBtn.disabled=true; navBanner.hidden=true;
  followPaused=false; resumeBtn.hidden=true;
}
resumeBtn.onclick = ()=>{ followPaused=false; resumeBtn.hidden=true; if (currentPosition) map.easeTo({center:currentPosition, duration:600, zoom:Math.max(map.getZoom(), 14)}); };

function onPos(pos){
  currentPosition = { lng: pos.coords.longitude, lat: pos.coords.latitude };
  if (userMarker) userMarker.setLngLat(currentPosition);

  const step = currentSteps[stepIndex];
  if (!step){ showBanner('Arrived',''); speak('Arrived.'); stopNavigation(); return; }

  const target = { lng: step.maneuver.location[0], lat: step.maneuver.location[1] };
  const meters = haversine(currentPosition, target);

  navSecondary.textContent = `${formatDistance(meters)} to next turn`;

  if (meters < 35){
    stepIndex++;
    if (currentSteps[stepIndex]) { showBanner(nextInstruction(), ''); speak(currentSteps[stepIndex].maneuver.instruction); }
    else { showBanner('Arrived',''); speak('Arrived.'); stopNavigation(); }
  }

  if (!followPaused){
    map.easeTo({ center: currentPosition, duration: 700, zoom: Math.max(14, map.getZoom()) });
  }
}

function onPosError(err){ console.warn('Geolocation error', err); }

/* ===================== UI HELPERS ===================== */
function showBanner(p,s){ navPrimary.textContent=p||''; navSecondary.textContent=s||''; navBanner.hidden=!(p||s); }
function nextInstruction(){ return currentSteps[stepIndex]?.maneuver?.instruction || 'Proceed'; }
function speak(text){ try{ const u=new SpeechSynthesisUtterance(text); window.speechSynthesis.cancel(); window.speechSynthesis.speak(u);}catch{} }
function haversine(a,b){
  const toRad=d=>d*Math.PI/180, R=6371000;
  const dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng);
  const s1=Math.sin(dLat/2), s2=Math.sin(dLng/2);
  return 2*R*Math.asin(Math.sqrt(s1*s1 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*s2*s2));
}
function formatDistance(m){ return (m>=1609.34) ? `${(m/1609.34).toFixed(1)} mi` : `${Math.round(m*3.28084)} ft`; }
</script>
</body>
</html>