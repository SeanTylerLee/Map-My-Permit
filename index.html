<!DOCTYPE html>
<html lang="en">
<head>
  <!-- iOS and mobile setup -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Map My Permit</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="styles.css" />

  <!-- Mapbox + Leaflet -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <!-- OCR: Tesseract -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.5/dist/tesseract.min.js"></script>
</head>
<body>

  <!-- Header -->
  <header>Map My Permit v3</header>

  <!-- Main App UI -->
  <main>
    <section>
      <h2>Select Permit</h2>
      <input type="file" id="permitInput" accept="image/*" />
      <div id="permitPreview"></div>
    </section>

    <section>
      <h2>Route Map</h2>
      <div id="map"></div>
    </section>

    <section>
      <p>Select your start and end point on the map. Then continue.</p>
      <button id="selectStart">Set Start</button>
      <button id="selectEnd">Set End</button>
      <button id="goToReview">Next</button>
    </section>

    <section>
      <h3>AI Extracted Directions</h3>
      <pre id="ocrOutput">Permit instructions will appear here after scan...</pre>
    </section>
  </main>

  <!-- iOS-style bottom nav -->
  <nav class="bottom-nav">
    <button onclick="history.back()">ğŸ”™ Back</button>
    <button onclick="location.href='index.html'">ğŸ  Home</button>
    <button onclick="location.href='settings.html'">âš™ï¸ Settings</button>
  </nav>

  <!-- Script logic -->
  <script>
    mapboxgl.accessToken = 'pk.eyJ1Ijoic2VhbmxlZTkyIiwiYSI6ImNtZTAyeG0wbzAwamgybHE2cmwzenJtM2cifQ.DE8FeoDvc3EzuyR5uPopzA';

    const map = L.map('map').setView([42.99, -105.55], 6);
    L.tileLayer(`https://api.mapbox.com/styles/v1/mapbox/streets-v11/tiles/{z}/{x}/{y}?access_token=${mapboxgl.accessToken}`, {
      attribution: 'Â© Mapbox Â© OpenStreetMap',
      tileSize: 512,
      zoomOffset: -1
    }).addTo(map);

    let startMarker = null;
    let endMarker = null;
    let selectingStart = false;
    let selectingEnd = false;
    let ocrText = "";

    document.getElementById('permitInput').addEventListener('change', async (event) => {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = async (e) => {
          const imageSrc = e.target.result;
          document.getElementById('permitPreview').innerHTML = `<img src="${imageSrc}" style="width:100%">`;

          const { data: { text } } = await Tesseract.recognize(imageSrc, 'eng');
          ocrText = text;
          document.getElementById('ocrOutput').textContent = text;
          localStorage.setItem('ocrText', text); // Save for use on review page
        };
        reader.readAsDataURL(file);
      }
    });

    document.getElementById('selectStart').onclick = () => {
      selectingStart = true;
      selectingEnd = false;
    };

    document.getElementById('selectEnd').onclick = () => {
      selectingStart = false;
      selectingEnd = true;
    };

    map.on('click', (e) => {
      const { lat, lng } = e.latlng;
      if (selectingStart) {
        if (startMarker) map.removeLayer(startMarker);
        startMarker = L.marker([lat, lng]).addTo(map).bindPopup("Start").openPopup();
        selectingStart = false;
        localStorage.setItem('manualStart', JSON.stringify([lat, lng]));
      } else if (selectingEnd) {
        if (endMarker) map.removeLayer(endMarker);
        endMarker = L.marker([lat, lng]).addTo(map).bindPopup("End").openPopup();
        selectingEnd = false;
        localStorage.setItem('manualEnd', JSON.stringify([lat, lng]));
      }
    });

    document.getElementById('goToReview').onclick = () => {
      if (!startMarker || !endMarker) {
        alert("Please select both a start and end point on the map first.");
        return;
      }

      if (!ocrText.trim()) {
        alert("OCR text not loaded yet. Please upload a permit image first.");
        return;
      }

      location.href = "review.html";
    };
  </script>
</body>
</html>